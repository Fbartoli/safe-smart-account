name: Deploy Safe Contracts (Matrix)

on:
  workflow_dispatch:
    inputs:
      node_rpc_url:
        description: 'RPC endpoint URL for blockchain connection'
        required: true
        type: string

env:
  NODE_VERSION: 22.14.0

jobs:
  deploy:
    strategy:
      fail-fast: false  # Continue other deployments if one fails
      matrix:
        tag: ["v1.4.1-3", "v1.3.0-1", "v1.3.0-libs.0"]
    
    uses: ./.github/workflows/deploy.yml
    with:
      node_rpc_url: ${{ github.event.inputs.node_rpc_url }}
      tag: ${{ matrix.tag }}
    secrets: inherit

  summary:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()  # Run even if some deployments failed
    
    steps:
    - name: Generate deployment summary
      run: |
        echo "## 🛡️ Safe Smart Account Multi-Version Deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Network:** custom" >> $GITHUB_STEP_SUMMARY
        
        echo "**Operation:** Deployment + Verification" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### 📋 Deployment Matrix Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Version | Package Manager | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|----------------|--------|" >> $GITHUB_STEP_SUMMARY
        
        # Check deployment results (this would need to be enhanced with actual job results)
        echo "| v1.4.1-3 | npm | ${{ needs.deploy.result == 'success' && '✅ Success' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| v1.3.0-1 | npm | ${{ needs.deploy.result == 'success' && '✅ Success' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| v1.3.0-libs.0 | yarn | ${{ needs.deploy.result == 'success' && '✅ Success' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### 🔗 Block Explorers" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- [Etherscan custom](https://custom.etherscan.io/)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### 📦 Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "Deployment artifacts are available in the workflow artifacts section above." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.deploy.result }}" != "success" ]; then
          echo "### ⚠️ Deployment Warnings" >> $GITHUB_STEP_SUMMARY
          echo "Some deployments may have failed. Check individual job logs for details." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ✅ All Deployments Successful" >> $GITHUB_STEP_SUMMARY
          echo "All Safe contract versions have been successfully deployed!" >> $GITHUB_STEP_SUMMARY
        fi

  notify-failure:
    needs: deploy
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: Notify on deployment failure
      run: |
        echo "## ❌ Matrix Deployment Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Network:** custom" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Error:** One or more deployments failed. Check individual job logs for details." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔍 Troubleshooting" >> $GITHUB_STEP_SUMMARY
        echo "1. Check individual matrix job logs above" >> $GITHUB_STEP_SUMMARY
        echo "2. Verify network configuration and secrets" >> $GITHUB_STEP_SUMMARY
        echo "3. Check if contracts are already deployed" >> $GITHUB_STEP_SUMMARY
