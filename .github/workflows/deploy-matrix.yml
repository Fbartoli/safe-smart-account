name: Deploy Safe Contracts (Matrix)

on:
  workflow_dispatch:
    inputs:
      node_rpc_url:
        description: 'RPC endpoint URL for blockchain connection'
        required: true
        type: string

env:
  NODE_VERSION: 22.14.0

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: custom
    
    strategy:
      fail-fast: false  # Continue other deployments if one fails
      matrix:
        include:
          - tag: "v1.4.1-3"
            package_manager: "npm"
            cache_key: "npm"
            install_cmd: "npm i --ignore-scripts"
            build_cmd: "npm run build"
            
          - tag: "v1.3.0-1"
            package_manager: "npm"
            cache_key: "npm"
            install_cmd: "npm ci --ignore-scripts"
            build_cmd: "npm run build"
            
          - tag: "v1.3.0-libs.0"
            package_manager: "yarn"
            cache_key: "yarn"
            install_cmd: "yarn install --frozen-lockfile"
            build_cmd: "yarn build"

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        ref: ${{ matrix.tag }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: ${{ matrix.cache_key }}

    - name: Install dependencies (${{ matrix.tag }})
      run: |
        echo "Installing dependencies for ${{ matrix.tag }} using ${{ matrix.package_manager }}"
        ${{ matrix.install_cmd }}

    - name: Build contracts (${{ matrix.tag }})
      run: |
        echo "Building contracts for ${{ matrix.tag }}"
        ${{ matrix.build_cmd }}

    - name: Deploy contracts (${{ matrix.tag }})
      env:
        HARDHAT_NETWORK: custom
        INFURA_KEY: ${{ secrets.INFURA_KEY }}
        ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        MNEMONIC: ${{ secrets.MNEMONIC }}
        NODE_URL: ${{ github.event.inputs.node_rpc_url }}
      run: |
        echo "🚀 Deploying ${{ matrix.tag }} to custom network"
        if [ "${{ matrix.tag }}" = "v1.3.0-libs.0" ]; then
          yarn deploy-all custom
        else
          npx hardhat deploy-contracts --network custom
        fi

    - name: Verify contracts (${{ matrix.tag }})
      env:
        HARDHAT_NETWORK: custom
        INFURA_KEY: ${{ secrets.INFURA_KEY }}
        ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        MNEMONIC: ${{ secrets.MNEMONIC }}
        NODE_URL: ${{ github.event.inputs.node_rpc_url }}
      run: |
        echo "🔍 Verifying ${{ matrix.tag }} on custom network"
        if [ "${{ matrix.tag }}" = "v1.3.0-libs.0" ]; then
          yarn hardhat --network custom etherscan-verify
          yarn hardhat --network custom local-verify
        else
          npx hardhat etherscan-verify --network custom --force-license true --license LGPL-3.0
          npx hardhat sourcify --network custom
        fi

    - name: Upload deployment artifacts (${{ matrix.tag }})
      uses: actions/upload-artifact@v4
      with:
        name: deployment-artifacts-${{ matrix.tag }}-custom-${{ github.sha }}
        path: |
          deployments/
          build/
        retention-days: 30

  summary:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()  # Run even if some deployments failed
    
    steps:
    - name: Generate deployment summary
      run: |
        echo "## 🛡️ Safe Smart Account Multi-Version Deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Network:** custom" >> $GITHUB_STEP_SUMMARY
        
        echo "**Operation:** Deployment + Verification" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### 📋 Deployment Matrix Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Version | Package Manager | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|----------------|--------|" >> $GITHUB_STEP_SUMMARY
        
        # Check deployment results (this would need to be enhanced with actual job results)
        echo "| v1.4.1-3 | npm | ${{ needs.deploy.result == 'success' && '✅ Success' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| v1.3.0-1 | npm | ${{ needs.deploy.result == 'success' && '✅ Success' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| v1.3.0-libs.0 | yarn | ${{ needs.deploy.result == 'success' && '✅ Success' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### 🔗 Block Explorers" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- [Etherscan custom](https://custom.etherscan.io/)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### 📦 Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "Deployment artifacts are available in the workflow artifacts section above." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.deploy.result }}" != "success" ]; then
          echo "### ⚠️ Deployment Warnings" >> $GITHUB_STEP_SUMMARY
          echo "Some deployments may have failed. Check individual job logs for details." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ✅ All Deployments Successful" >> $GITHUB_STEP_SUMMARY
          echo "All Safe contract versions have been successfully deployed!" >> $GITHUB_STEP_SUMMARY
        fi

  notify-failure:
    needs: deploy
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: Notify on deployment failure
      run: |
        echo "## ❌ Matrix Deployment Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Network:** custom" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Error:** One or more deployments failed. Check individual job logs for details." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔍 Troubleshooting" >> $GITHUB_STEP_SUMMARY
        echo "1. Check individual matrix job logs above" >> $GITHUB_STEP_SUMMARY
        echo "2. Verify network configuration and secrets" >> $GITHUB_STEP_SUMMARY
        echo "3. Check if contracts are already deployed" >> $GITHUB_STEP_SUMMARY
