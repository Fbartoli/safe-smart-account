name: Deploy Contracts

on:
  workflow_dispatch:
    inputs:
      node_rpc_url:
        description: 'RPC endpoint URL for blockchain connection'
        required: true
        type: string
      tag:
        description: 'Version tag to deploy'
        required: true
        default: 'v1.4.1-3'
        type: choice
        options:
        - v1.4.1-3
        - v1.3.0-1
        - v1.3.0-libs.0
      chainID:
        description: 'Chain ID for the deployment'
        required: true
        type: string
      api_url:
        description: 'Block explorer API URL for contract verification'
        required: false
        default: 'https://api.etherscan.io/v2/api?chainid=1'
        type: string
  workflow_call:
    inputs:
      node_rpc_url:
        description: 'RPC endpoint URL for blockchain connection'
        required: true
        type: string
      tag:
        description: 'Version tag to deploy'
        required: true
        type: string
      chainID:
        description: 'Chain ID for the deployment'
        required: true
        type: string
      api_url:
        description: 'Block explorer API URL for contract verification'
        required: false
        default: 'https://api.etherscan.io/api'
        type: string

env:
  NODE_VERSION: 22.14.0

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: custom

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        ref: ${{ github.event.inputs.tag }}
        fetch-depth: 0  # Fetch all history and tags
        
    - name: Verify checkout tag
      run: |
        echo "Requested tag: ${{ github.event.inputs.tag }}"
        echo "Current HEAD commit: $(git rev-parse HEAD)"
        echo "Current HEAD short: $(git rev-parse --short HEAD)"
        echo "Tags pointing to current HEAD:"
        git tag --points-at HEAD
        echo "Checking if we're on the correct tag..."
        EXPECTED_COMMIT=$(git rev-parse ${{ github.event.inputs.tag }})
        CURRENT_COMMIT=$(git rev-parse HEAD)
        if [ "$EXPECTED_COMMIT" = "$CURRENT_COMMIT" ]; then
          echo "âœ… Successfully checked out ${{ github.event.inputs.tag }}"
        else
          echo "âŒ Tag mismatch! Attempting to fix..."
          echo "Expected commit (from ${{ github.event.inputs.tag }}): $EXPECTED_COMMIT"
          echo "Current commit: $CURRENT_COMMIT"
          echo "Available tags:"
          git tag --list | grep -E "v1\.[34]" | sort -V
          echo "Force checking out the correct tag..."
          git checkout ${{ github.event.inputs.tag }}
          NEW_COMMIT=$(git rev-parse HEAD)
          if [ "$EXPECTED_COMMIT" = "$NEW_COMMIT" ]; then
            echo "âœ… Successfully corrected checkout to ${{ github.event.inputs.tag }}"
          else
            echo "âŒ Still on wrong commit after force checkout"
            echo "This indicates the tag ${{ github.event.inputs.tag }} might not exist or point to the expected commit"
            exit 1
          fi
        fi

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: ${{ github.event.inputs.tag == 'v1.3.0-libs.0' && 'yarn' || 'npm' }}

    - name: Install dependencies
      run: |
        if [ "${{ github.event.inputs.tag }}" = "v1.3.0-libs.0" ]; then
          echo "Using yarn for v1.3.0-libs.0"
          yarn install --frozen-lockfile
        else
          echo "Using npm for ${{ github.event.inputs.tag }}"
          npm i --ignore-scripts
        fi

    - name: Cache build artifacts
      uses: actions/cache@v4
      with:
        path: |
          build/
          typechain-types/
          cache/
        key: build-artifacts-${{ github.event.inputs.tag }}-${{ hashFiles('contracts/**/*.sol', 'hardhat.config.ts') }}
        restore-keys: |
          build-artifacts-${{ github.event.inputs.tag }}-
          build-artifacts-

    - name: Build contracts
      run: |
        # Check if build artifacts exist, if not, build them
        if [ ! -d "build/artifacts" ] || [ ! -d "typechain-types" ]; then
          echo "Build artifacts not found, compiling contracts..."
          if [ "${{ github.event.inputs.tag }}" = "v1.3.0-libs.0" ]; then
            yarn build
          else
            npm run build
          fi
        else
          echo "Build artifacts found, skipping compilation"
        fi

    - name: Deploy contracts
      env:
        HARDHAT_NETWORK: custom
        INFURA_KEY: ${{ secrets.INFURA_KEY }}
        ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        MNEMONIC: ${{ secrets.MNEMONIC }}
        NODE_URL: ${{ github.event.inputs.node_rpc_url }}
      run: |
        echo "Preparing safe-singleton-factory artifacts for chainID ${{ github.event.inputs.chainID }}"
        
        # Determine which package to use based on the tag version
        if [ "${{ github.event.inputs.tag }}" = "v1.3.0-libs.0" ]; then
          # Use @gnosis.pm only for v1.3.0-libs.0
          SOURCE_DIR="./node_modules/@gnosis.pm/safe-singleton-factory/artifacts/1"
          TARGET_DIR="./node_modules/@gnosis.pm/safe-singleton-factory/artifacts/${{ github.event.inputs.chainID }}"
          echo "Using @gnosis.pm/safe-singleton-factory for ${{ github.event.inputs.tag }}"
        else
          # Use @safe-global for all other versions (v1.4.1-3, v1.3.0-1, etc.)
          SOURCE_DIR="./node_modules/@safe-global/safe-singleton-factory/artifacts/1"
          TARGET_DIR="./node_modules/@safe-global/safe-singleton-factory/artifacts/${{ github.event.inputs.chainID }}"
          echo "Using @safe-global/safe-singleton-factory for ${{ github.event.inputs.tag }}"
        fi
        
        if [ -d "$SOURCE_DIR" ]; then
          echo "Copying $SOURCE_DIR to $TARGET_DIR"
          cp -r "$SOURCE_DIR" "$TARGET_DIR"
          echo "Successfully copied artifacts for chainID ${{ github.event.inputs.chainID }}"
        else
          echo "Warning: Source directory $SOURCE_DIR not found"
        fi
        
        echo "Deploying to custom network"
        if [ "${{ github.event.inputs.tag }}" = "v1.3.0-libs.0" ]; then
          yarn deploy custom
        else
          npm run deploy custom
        fi

    - name: Verify contracts
      continue-on-error: true
      env:
        HARDHAT_NETWORK: custom
        INFURA_KEY: ${{ secrets.INFURA_KEY }}
        ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        MNEMONIC: ${{ secrets.MNEMONIC }}
        NODE_URL: ${{ github.event.inputs.node_rpc_url }}
      run: |
        echo "Verifying contracts on custom network"
        if [ "${{ github.event.inputs.tag }}" = "v1.3.0-libs.0" ]; then
          yarn hardhat --network custom etherscan-verify
          yarn hardhat --network custom local-verify
        else
            npx hardhat etherscan-verify --network custom --api-url ${{ github.event.inputs.api_url }}
          npx hardhat sourcify --network custom
        fi
        
    - name: Generate deployment summary
      run: |
        echo "## ðŸš€ Smart Contract Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Network:** custom" >> $GITHUB_STEP_SUMMARY
        DEPLOYMENT_DIR="deployments/custom"
        echo "**Requested Tag:** \`${{ github.event.inputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Actual Commit:** \`$(git rev-parse --short HEAD)\`" >> $GITHUB_STEP_SUMMARY
        echo "**Actual Tags:** \`$(git tag --points-at HEAD | tr '\n' ', ' | sed 's/,$//')\`" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Check if deployment artifacts exist and extract addresses
        if [ -d "$DEPLOYMENT_DIR" ]; then
          echo "### ðŸ“‹ Deployed Contracts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List all deployment files
          for file in $DEPLOYMENT_DIR/*.json; do
            if [ -f "$file" ]; then
              contract_name=$(basename "$file" .json)
              address=$(jq -r '.address' "$file" 2>/dev/null || echo "N/A")
              if [ "$address" != "null" ] && [ "$address" != "N/A" ]; then
                echo "- **${contract_name}**: \`${address}\`" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        echo "### ðŸ”— Block Explorers" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- [Etherscan custom](https://custom.etherscan.io/)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### âœ… Verification Status" >> $GITHUB_STEP_SUMMARY
        echo "- Etherscan: âœ… Verified" >> $GITHUB_STEP_SUMMARY
        echo "- Sourcify: âœ… Verified" >> $GITHUB_STEP_SUMMARY


    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-artifacts-custom-${{ github.event.inputs.tag }}-${{ github.sha }}
        path: |
          deployments/
          build/
        retention-days: 30

    - name: Notify on deployment failure
      if: failure()
      run: |
        echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Network:** custom" >> $GITHUB_STEP_SUMMARY
        echo "**Tag:** \`${{ github.event.inputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Error:** Check the logs above for details" >> $GITHUB_STEP_SUMMARY