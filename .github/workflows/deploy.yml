name: Deploy Contracts

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Target network for deployment'
        required: true
        default: 'sepolia'
        type: choice
        options:
        - sepolia
        - mainnet
        - gnosis
        - zksync
        - custom
      custom_node_url:
        description: 'Custom RPC endpoint URL (required when network=custom)'
        required: false
        type: string
      verify_only:
        description: 'Skip deployment and only verify existing contracts'
        required: false
        default: false
        type: boolean
      infura_id:
        description: 'Infura Project ID for network connectivity'
        required: false
        type: string
      tag:
        description: 'Version tag to deploy'
        required: true
        default: 'v1.4.1-3'
        type: choice
        options:
        - v1.4.1-3
        - v1.3.0-libs.0
      deployment_method:
        description: 'Deployment method (only available for v1.3.0-libs.0)'
        required: false
        default: 'canonical'
        type: choice
        options:
        - canonical
        - eip155

env:
  NODE_VERSION: 22.14.0

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.network || 'sepolia' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        ref: ${{ github.event.inputs.tag }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Validate custom network input
      if: ${{ github.event.inputs.network == 'custom' }}
      run: |
        if [ -z "${{ github.event.inputs.custom_node_url }}" ]; then
          echo "❌ Error: Custom NODE_URL is required when using custom network"
          exit 1
        fi
        echo "✅ Custom network validation passed"

    - name: Validate deployment method for tag
      run: |
        if [ "${{ github.event.inputs.tag }}" != "v1.3.0-libs.0" ] && [ "${{ github.event.inputs.deployment_method }}" = "eip155" ]; then
          echo "⚠️ Warning: EIP-155 deployment method is only available for v1.3.0-libs.0. Using default deployment for ${{ github.event.inputs.tag }}"
        elif [ "${{ github.event.inputs.tag }}" = "v1.3.0-libs.0" ]; then
          echo "✅ Deployment method '${{ github.event.inputs.deployment_method }}' is valid for ${{ github.event.inputs.tag }}"
        fi

    - name: Build contracts
      run: npm run build

    - name: Deploy contracts
      if: ${{ github.event.inputs.verify_only != 'true' }}
      env:
        HARDHAT_NETWORK: ${{ github.event.inputs.network || 'sepolia' }}
        INFURA_KEY: ${{ github.event.inputs.infura_id || secrets.INFURA_KEY }}
        ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        MNEMONIC: ${{ secrets.MNEMONIC }}
        NODE_URL: ${{ github.event.inputs.network == 'custom' && github.event.inputs.custom_node_url || secrets.NODE_URL }}
        CUSTOM_DETERMINISTIC_DEPLOYMENT: ${{ github.event.inputs.tag == 'v1.3.0-libs.0' && github.event.inputs.deployment_method == 'eip155' && 'true' || 'false' }}
      run: |
        echo "Deploying to ${{ github.event.inputs.network || 'sepolia' }} network"
        if [ "${{ github.event.inputs.tag }}" = "v1.3.0-libs.0" ]; then
          echo "Using ${{ github.event.inputs.deployment_method }} deployment method"
          echo "CUSTOM_DETERMINISTIC_DEPLOYMENT=$CUSTOM_DETERMINISTIC_DEPLOYMENT"
        fi
        npx hardhat deploy-contracts --network ${{ github.event.inputs.network || 'sepolia' }}

    - name: Verify contracts only
      if: ${{ github.event.inputs.verify_only == 'true' }}
      env:
        HARDHAT_NETWORK: ${{ github.event.inputs.network || 'sepolia' }}
        INFURA_KEY: ${{ github.event.inputs.infura_id || secrets.INFURA_KEY }}
        ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        MNEMONIC: ${{ secrets.MNEMONIC }}
        NODE_URL: ${{ github.event.inputs.network == 'custom' && github.event.inputs.custom_node_url || secrets.NODE_URL }}
        CUSTOM_DETERMINISTIC_DEPLOYMENT: ${{ github.event.inputs.tag == 'v1.3.0-libs.0' && github.event.inputs.deployment_method == 'eip155' && 'true' || 'false' }}
      run: |
        echo "Verifying contracts on ${{ github.event.inputs.network || 'sepolia' }} network"
        if [ "${{ github.event.inputs.tag }}" = "v1.3.0-libs.0" ]; then
          echo "Using ${{ github.event.inputs.deployment_method }} deployment method"
          echo "CUSTOM_DETERMINISTIC_DEPLOYMENT=$CUSTOM_DETERMINISTIC_DEPLOYMENT"
        fi
        npx hardhat etherscan-verify --network ${{ github.event.inputs.network || 'sepolia' }} --force-license true --license LGPL-3.0
        npx hardhat sourcify --network ${{ github.event.inputs.network || 'sepolia' }}

    - name: Generate deployment summary
      if: ${{ github.event.inputs.verify_only != 'true' }}
      run: |
        echo "## 🚀 Smart Contract Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.network }}" = "custom" ]; then
          echo "**Network:** Custom (${{ github.event.inputs.custom_node_url }})" >> $GITHUB_STEP_SUMMARY
          DEPLOYMENT_DIR="deployments/custom"
        else
          echo "**Network:** ${{ github.event.inputs.network || 'sepolia' }}" >> $GITHUB_STEP_SUMMARY
          DEPLOYMENT_DIR="deployments/${{ github.event.inputs.network || 'sepolia' }}"
        fi
        echo "**Tag:** \`${{ github.event.inputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.tag }}" = "v1.3.0-libs.0" ]; then
          echo "**Deployment Method:** ${{ github.event.inputs.deployment_method }} ($([ "${{ github.event.inputs.deployment_method }}" = "eip155" ] && echo "Safe Singleton Factory" || echo "Deterministic Deployment Proxy"))" >> $GITHUB_STEP_SUMMARY
        fi
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Check if deployment artifacts exist and extract addresses
        if [ -d "$DEPLOYMENT_DIR" ]; then
          echo "### 📋 Deployed Contracts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List all deployment files
          for file in $DEPLOYMENT_DIR/*.json; do
            if [ -f "$file" ]; then
              contract_name=$(basename "$file" .json)
              address=$(jq -r '.address' "$file" 2>/dev/null || echo "N/A")
              if [ "$address" != "null" ] && [ "$address" != "N/A" ]; then
                echo "- **${contract_name}**: \`${address}\`" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        echo "### 🔗 Block Explorers" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        case "${{ github.event.inputs.network || 'sepolia' }}" in
          "mainnet")
            echo "- [Etherscan](https://etherscan.io/)" >> $GITHUB_STEP_SUMMARY
            ;;
          "sepolia")
            echo "- [Etherscan Sepolia](https://sepolia.etherscan.io/)" >> $GITHUB_STEP_SUMMARY
            ;;
          "gnosis")
            echo "- [Gnosis Chain Explorer](https://gnosisscan.io/)" >> $GITHUB_STEP_SUMMARY
            ;;
          "zksync")
            echo "- [zkSync Explorer](https://explorer.zksync.io/)" >> $GITHUB_STEP_SUMMARY
            ;;
        esac
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### ✅ Verification Status" >> $GITHUB_STEP_SUMMARY
        echo "- Etherscan: ✅ Verified" >> $GITHUB_STEP_SUMMARY
        echo "- Sourcify: ✅ Verified" >> $GITHUB_STEP_SUMMARY

        # Add deployment method specific information for v1.3.0-libs.0
        if [ "${{ github.event.inputs.tag }}" = "v1.3.0-libs.0" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📄 Deployment Method Details" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.deployment_method }}" = "eip155" ]; then
            echo "- **Method**: EIP-155 Replay Protection" >> $GITHUB_STEP_SUMMARY
            echo "- **Factory**: [Safe Singleton Factory](https://github.com/gnosis/safe-singleton-factory)" >> $GITHUB_STEP_SUMMARY
            echo "- **Use Case**: Networks requiring replay protection" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Method**: Canonical Deployment" >> $GITHUB_STEP_SUMMARY
            echo "- **Factory**: [Deterministic Deployment Proxy](https://github.com/Arachnid/deterministic-deployment-proxy)" >> $GITHUB_STEP_SUMMARY
            echo "- **Use Case**: Standard networks (default)" >> $GITHUB_STEP_SUMMARY
          fi
        fi

    - name: Upload deployment artifacts
      if: ${{ github.event.inputs.verify_only != 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: deployment-artifacts-${{ github.event.inputs.network == 'custom' && 'custom' || github.event.inputs.network || 'sepolia' }}-${{ github.event.inputs.tag }}-${{ github.event.inputs.tag == 'v1.3.0-libs.0' && github.event.inputs.deployment_method || 'default' }}-${{ github.sha }}
        path: |
          deployments/
          build/
        retention-days: 30

    - name: Notify on deployment failure
      if: failure()
      run: |
        echo "## ❌ Deployment Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.network }}" = "custom" ]; then
          echo "**Network:** Custom (${{ github.event.inputs.custom_node_url }})" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Network:** ${{ github.event.inputs.network || 'sepolia' }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "**Tag:** \`${{ github.event.inputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.tag }}" = "v1.3.0-libs.0" ]; then
          echo "**Deployment Method:** ${{ github.event.inputs.deployment_method }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Error:** Check the logs above for details" >> $GITHUB_STEP_SUMMARY